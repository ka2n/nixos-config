---
# Development tools and environment
# Note: Language runtimes (Go, Python, Node.js, Rust, Zig) are installed in base role

# Version managers
- name: Install mise (version manager)
  block:
    - name: Download and install mise
      shell: |
        curl https://mise.run | sh
      args:
        creates: "{{ ansible_env.HOME }}/.local/bin/mise"
      become: no

    - name: Add mise to shell
      lineinfile:
        path: "{{ ansible_env.HOME }}/.bashrc"
        line: 'eval "$({{ ansible_env.HOME }}/.local/bin/mise activate bash)"'
        create: yes
      become: no

# Dotfiles manager
- name: Install chezmoi via official script
  shell: |
    sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "$HOME/.local/bin"
  args:
    creates: "{{ ansible_env.HOME }}/.local/bin/chezmoi"
  become: no

# Editors
- name: Build and install Neovim from source
  vars:
    neovim_version: "0.11.5"
  block:
    - name: Install Neovim build dependencies
      apt:
        name:
          - ninja-build
          - gettext
          - cmake
          - curl
          - build-essential
          - git
        state: present
      become: yes

    - name: Clone Neovim repository
      git:
        repo: https://github.com/neovim/neovim.git
        dest: /tmp/neovim
        version: "v{{ neovim_version }}"
        depth: 1
        force: yes
      become: no

    - name: Build Neovim
      shell: |
        cd /tmp/neovim
        make CMAKE_BUILD_TYPE=RelWithDebInfo
      args:
        creates: /tmp/neovim/build/bin/nvim
      become: no

    - name: Install Neovim
      shell: |
        cd /tmp/neovim
        make install
      become: yes

    - name: Clean up Neovim build directory
      file:
        path: /tmp/neovim
        state: absent
      become: no

- name: Create vi/vim aliases for neovim
  block:
    - name: Update alternatives for vi
      alternatives:
        name: vi
        path: /usr/local/bin/nvim
      become: yes
      ignore_errors: yes

    - name: Update alternatives for vim
      alternatives:
        name: vim
        path: /usr/local/bin/nvim
      become: yes
      ignore_errors: yes

- name: Install Fish shell
  apt:
    name: fish
    state: present
  become: yes

- name: Install shell enhancements
  block:
    # Starship prompt
    - name: Download and install starship
      shell: |
        curl -sS https://starship.rs/install.sh | sh -s -- -y
      args:
        creates: /usr/local/bin/starship
      become: yes

    # Atuin - shell history
    - name: Download and install atuin
      shell: |
        curl --proto '=https' --tlsv1.2 -LsSf https://setup.atuin.sh | sh
      args:
        creates: "{{ ansible_env.HOME }}/.cargo/bin/atuin"
      become: no

# Docker
- name: Install Docker
  block:
    - name: Install Docker prerequisites
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
      become: yes

    - name: Download Docker GPG key
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/docker-archive-keyring.gpg
      become: yes

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu noble stable"
        state: present
        filename: docker
      become: yes

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes
      become: yes

    - name: Add user to docker group
      user:
        name: "{{ primary_user }}"
        groups: docker
        append: yes
      become: yes

    - name: Enable and start Docker service
      systemd:
        name: docker
        enabled: yes
        state: started
      become: yes

# Git configuration
- name: Ensure git is installed
  apt:
    name: git
    state: present
  become: yes

- name: Install tig (text-mode interface for git)
  apt:
    name: tig
    state: present
  become: yes

# NoiseTorch - microphone noise suppression
- name: Install NoiseTorch
  vars:
    noisetorch_version: "0.12.2"
  block:
    - name: Download NoiseTorch
      get_url:
        url: "https://github.com/noisetorch/NoiseTorch/releases/download/v{{ noisetorch_version }}/NoiseTorch_x64_v{{ noisetorch_version }}.tgz"
        dest: /tmp/noisetorch.tgz
      become: no

    - name: Extract NoiseTorch to user local directory
      unarchive:
        src: /tmp/noisetorch.tgz
        dest: "{{ ansible_env.HOME }}"
        remote_src: yes
      become: no
      args:
        creates: "{{ ansible_env.HOME }}/.local/bin/noisetorch"

# Additional CLI utilities (installed via cargo/go if available)
- name: Install just task runner via cargo
  shell: |
    . $HOME/.cargo/env && cargo install just
  args:
    creates: "{{ ansible_env.HOME }}/.cargo/bin/just"
  become: no
  ignore_errors: yes

- name: Install ghq repository manager via go
  shell: |
    export PATH="$HOME/go/bin:$PATH" && go install github.com/x-motemen/ghq@latest
  args:
    creates: "{{ ansible_env.HOME }}/go/bin/ghq"
  become: no
  environment:
    GOPATH: "{{ ansible_env.HOME }}/go"
  ignore_errors: yes

# Yazi file manager - install from official binary release
- name: Install yazi dependencies
  apt:
    name:
      - ffmpeg
      - p7zip-full
      - jq
      - poppler-utils
      - fd-find
      - ripgrep
      - fzf
      - zoxide
      - imagemagick
    state: present
  become: yes

- name: Install yazi file manager
  vars:
    yazi_version: "25.5.31"
  block:
    - name: Download yazi binary
      get_url:
        url: "https://github.com/sxyazi/yazi/releases/download/v{{ yazi_version }}/yazi-x86_64-unknown-linux-gnu.zip"
        dest: /tmp/yazi.zip
      become: no

    - name: Create yazi extraction directory
      file:
        path: /tmp/yazi-extract
        state: directory
        mode: '0755'
      become: no

    - name: Extract yazi
      unarchive:
        src: /tmp/yazi.zip
        dest: /tmp/yazi-extract
        remote_src: yes
      become: no

    - name: Install yazi binary
      copy:
        src: /tmp/yazi-extract/yazi-x86_64-unknown-linux-gnu/yazi
        dest: /usr/local/bin/yazi
        mode: '0755'
        remote_src: yes
      become: yes

    - name: Install ya binary (yazi helper)
      copy:
        src: /tmp/yazi-extract/yazi-x86_64-unknown-linux-gnu/ya
        dest: /usr/local/bin/ya
        mode: '0755'
        remote_src: yes
      become: yes

# Note: PATH additions for cargo, go, and local bin are in base role

- name: Add local bin to PATH
  lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: 'export PATH="$HOME/.local/bin:$PATH"'
    create: yes
  become: no
