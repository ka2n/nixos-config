---
# Microsoft Defender for Endpoint (mdatp) installation
# Uses Python script onboarding method (MicrosoftDefenderATPOnboardingLinuxServer.py)

- name: Display mdatp installation information
  debug:
    msg: |
      Installing Microsoft Defender for Endpoint...
      Using official installer script method.
      Channel: {{ mdatp_channel }}

- name: Check if onboarding package is provided
  fail:
    msg: |
      ERROR: mdatp_onboarding variable is not set or file does not exist.

      Please download WindowsDefenderATPOnboardingPackage.zip from:
      Microsoft Defender Portal > Settings > Endpoints > Device management > Onboarding

      Then run:
      ansible-playbook enterprise.yml --ask-become-pass \
        --extra-vars "mdatp_onboarding=/path/to/WindowsDefenderATPOnboardingPackage.zip"
  when: mdatp_onboarding is not defined or mdatp_onboarding == "" or not (mdatp_onboarding | default('') | length > 0)

- name: Verify onboarding package exists
  stat:
    path: "{{ mdatp_onboarding }}"
  register: onboarding_file
  when: mdatp_onboarding is defined and mdatp_onboarding != ""

- name: Fail if onboarding package does not exist
  fail:
    msg: "Onboarding package not found at: {{ mdatp_onboarding }}"
  when: mdatp_onboarding is defined and mdatp_onboarding != "" and not onboarding_file.stat.exists

- name: Install prerequisites
  apt:
    name:
      - curl
      - python3-apt
      - python3
    state: present
  become: yes

- name: Create temporary directory for mdatp installation
  file:
    path: /tmp/mde_install
    state: directory
    mode: '0755'
  become: yes

- name: Download mdatp installer script
  get_url:
    url: "{{ mdatp_installer_url }}"
    dest: /tmp/mde_installer.sh
    mode: '0755'
  become: yes

- name: Extract onboarding package
  unarchive:
    src: "{{ mdatp_onboarding }}"
    dest: /tmp/mde_install/
    remote_src: no
  become: yes
  when: mdatp_onboarding is defined and mdatp_onboarding != ""

- name: Find onboarding Python script
  find:
    paths: /tmp/mde_install/
    patterns: "*.py"
  register: onboarding_py_files
  become: yes

- name: Set onboarding Python script path
  set_fact:
    onboarding_py_path: "{{ onboarding_py_files.files[0].path }}"
  when: onboarding_py_files.matched > 0

- name: Fail if no onboarding script found
  fail:
    msg: |
      No onboarding Python script found in the package.
      Expected: MicrosoftDefenderATPOnboardingLinuxServer.py
  when: onboarding_py_files.matched == 0

- name: Install mdatp using installer script
  shell: |
    /tmp/mde_installer.sh --install --channel {{ mdatp_channel }}
  become: yes
  register: mdatp_install_output

- name: Display installation output
  debug:
    msg: "{{ mdatp_install_output.stdout_lines }}"
  when: mdatp_install_output.stdout_lines is defined

- name: Onboard using Python script
  shell: |
    python3 {{ onboarding_py_path }}
  become: yes
  register: mdatp_onboard_output
  when: onboarding_py_path is defined

- name: Display onboarding output
  debug:
    msg: "{{ mdatp_onboard_output.stdout_lines }}"
  when: mdatp_onboard_output.stdout_lines is defined

- name: Wait for mdatp to be ready
  shell: mdatp health --field healthy
  register: mdatp_health
  retries: 10
  delay: 5
  until: mdatp_health.rc == 0
  become: yes
  ignore_errors: yes

- name: Check real-time protection status
  shell: mdatp health --field real_time_protection_enabled
  register: rtp_status
  become: yes
  ignore_errors: yes

- name: Enable real-time protection if disabled
  shell: mdatp config real-time-protection --value enabled
  become: yes
  when: rtp_status.stdout is defined and rtp_status.stdout == "false"

- name: Check mdatp health
  shell: mdatp health
  register: mdatp_health_full
  become: yes
  ignore_errors: yes

- name: Display mdatp health
  debug:
    msg: "{{ mdatp_health_full.stdout_lines }}"
  when: mdatp_health_full.stdout_lines is defined

- name: Test mdatp connectivity
  shell: mdatp connectivity test
  register: mdatp_connectivity
  become: yes
  ignore_errors: yes

- name: Display connectivity test results
  debug:
    msg: "{{ mdatp_connectivity.stdout_lines }}"
  when: mdatp_connectivity.stdout_lines is defined

- name: Clean up temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/mde_install
    - /tmp/mde_installer.sh
  become: yes

- name: Display post-installation message
  debug:
    msg: |
      ========================================
      Microsoft Defender for Endpoint Installation Complete
      ========================================

      Status: {{ 'Healthy' if mdatp_health.rc == 0 else 'Check required' }}

      Useful commands:
      - Check health: sudo mdatp health
      - Test connectivity: sudo mdatp connectivity test
      - Full health status: sudo mdatp health --field all
      - Get version: sudo mdatp version

      IMPORTANT: A system reboot is recommended.

      Before upgrading Ubuntu to a new major version:
      1. Uninstall mdatp first
      2. Perform OS upgrade
      3. Reinstall and reconfigure mdatp

      To uninstall (use the installer script):
      /tmp/mde_installer.sh --remove

      ========================================
