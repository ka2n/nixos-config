---
# Security tools: 1Password, gnome-keyring

# GNOME Keyring
- name: Install GNOME Keyring
  apt:
    name:
      - gnome-keyring
      - seahorse  # GUI for keyring management
      - libpam-gnome-keyring
    state: present
  become: yes

- name: Enable GNOME Keyring in PAM
  lineinfile:
    path: /etc/pam.d/login
    line: "auth       optional     pam_gnome_keyring.so"
    insertafter: "^auth"
  become: yes

- name: Enable GNOME Keyring session in PAM
  lineinfile:
    path: /etc/pam.d/login
    line: "session    optional     pam_gnome_keyring.so auto_start"
    insertafter: "^session"
  become: yes

- name: Create GNOME Keyring autostart entry
  copy:
    dest: "{{ ansible_env.HOME }}/.config/autostart/gnome-keyring.desktop"
    content: |
      [Desktop Entry]
      Type=Application
      Name=GNOME Keyring
      Exec=/usr/bin/gnome-keyring-daemon --start --components=pkcs11,secrets,ssh
      NoDisplay=true
      X-GNOME-Autostart-Phase=PreDisplayServer
    mode: '0644'
  become: no

# 1Password
- name: Install 1Password
  block:
    - name: Add 1Password apt key
      get_url:
        url: "{{ onepassword_apt_key_url }}"
        dest: /usr/share/keyrings/1password-archive-keyring.gpg
      become: yes

    - name: Add 1Password repository
      apt_repository:
        repo: "{{ onepassword_apt_repo }}"
        state: present
        filename: 1password
      become: yes

    - name: Add 1Password repository with signed-by
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/amd64 stable main"
        state: present
        filename: 1password
      become: yes

    - name: Create 1Password policy directory
      file:
        path: /etc/polkit-1/rules.d
        state: directory
        mode: '0755'
      become: yes

    - name: Install 1Password
      apt:
        name: 1password
        state: present
        update_cache: yes
      become: yes

    - name: Install 1Password CLI
      apt:
        name: 1password-cli
        state: present
      become: yes

- name: Configure 1Password for custom browsers
  block:
    - name: Create 1Password configuration directory
      file:
        path: /etc/1password
        state: directory
        mode: '0755'
      become: yes

    - name: Create custom allowed browsers file
      template:
        src: 1password-browsers.j2
        dest: /etc/1password/custom_allowed_browsers
        mode: '0755'
      become: yes

- name: Install PolicyKit authentication agent
  apt:
    name:
      - polkit-kde-agent-1
    state: present
  become: yes

- name: Create PolicyKit autostart for Hyprland
  copy:
    dest: "{{ ansible_env.HOME }}/.config/autostart/polkit-kde-agent.desktop"
    content: |
      [Desktop Entry]
      Type=Application
      Name=PolicyKit Authentication Agent
      Exec=/usr/lib/polkit-kde-authentication-agent-1
      NoDisplay=true
      X-GNOME-Autostart-Phase=Initialization
    mode: '0644'
  become: no
