---
# Japanese input method configuration (fcitx5 + SKK)

- name: Install fcitx5 base packages
  apt:
    name:
      - fcitx5
      - fcitx5-frontend-gtk2
      - fcitx5-frontend-gtk3
      - fcitx5-frontend-gtk4
      - fcitx5-frontend-qt5
      - fcitx5-config-qt
      - fcitx5-module-wayland
      - im-config
    state: present
  become: yes

- name: Install fcitx5-skk (standard SKK, fallback if fcitx5-cskk fails)
  apt:
    name: fcitx5-skk
    state: present
  become: yes
  ignore_errors: yes

# Build libcskk (dependency for fcitx5-cskk)
- name: Build libcskk from source
  block:
    - name: Install libcskk build dependencies
      apt:
        name:
          - build-essential
          - cargo
          - rustc
          - libxkbcommon-dev
        state: present
      become: yes

    - name: Install Rust build tools (cbindgen and cargo-c)
      shell: |
        cargo install cbindgen || true
        cargo install --locked cargo-c@0.10.7
      args:
        creates: "{{ ansible_env.HOME }}/.cargo/bin/cargo-cbuild"
      become: no

    - name: Clone libcskk repository
      git:
        repo: "{{ libcskk_repo }}"
        dest: /tmp/libcskk-build
        depth: 1
      become: no

    - name: Build libcskk
      shell: |
        cd /tmp/libcskk-build
        cargo cbuild --release
      args:
        creates: /tmp/libcskk-build/target/release/libcskk.so
      become: no
      environment:
        PATH: "{{ ansible_env.HOME }}/.cargo/bin:{{ ansible_env.PATH }}"

    - name: Install libcskk
      shell: |
        cd /tmp/libcskk-build
        /home/{{ ansible_user_id }}/.cargo/bin/cargo cinstall --release --prefix="/usr"
      args:
        creates: /usr/lib/libcskk.so
      become: yes
      environment:
        PATH: "/home/{{ ansible_user_id }}/.cargo/bin:{{ ansible_env.PATH }}"
        CARGO_HOME: "/home/{{ ansible_user_id }}/.cargo"
        RUSTUP_HOME: "/home/{{ ansible_user_id }}/.rustup"

    - name: Fix libcskk pkgconfig prefix
      lineinfile:
        path: /usr/lib/x86_64-linux-gnu/pkgconfig/cskk.pc
        regexp: '^prefix='
        line: 'prefix=/usr'
      become: yes

# Build fcitx5-cskk from source
- name: Build fcitx5-cskk from source
  block:
    - name: Install fcitx5-cskk build dependencies
      apt:
        name:
          - build-essential
          - cmake
          - extra-cmake-modules
          - gettext
          - libfcitx5core-dev
          - fcitx5-modules-dev
          - qt6-base-dev
          - qt6-declarative-dev
          - libfcitx5-qt-dev
          - libfcitx5-qt6-dev
        state: present
      become: yes

    - name: Clone fcitx5-cskk repository
      git:
        repo: "{{ fcitx5_cskk_repo }}"
        dest: /tmp/fcitx5-cskk-build
        version: "{{ fcitx5_cskk_ref }}"
      become: no

    - name: Build fcitx5-cskk
      shell: |
        cd /tmp/fcitx5-cskk-build
        rm -rf ./build
        mkdir build
        cd build
        cmake ..
        make -j$(nproc)
      args:
        creates: /tmp/fcitx5-cskk-build/build/src/cskk.so
      become: no

    - name: Install fcitx5-cskk
      shell: |
        cd /tmp/fcitx5-cskk-build/build
        make install
      args:
        creates: /usr/local/lib/fcitx5/cskk.so
      become: yes

- name: Download SKK dictionaries
  block:
    - name: Create SKK dictionary directory
      file:
        path: /usr/share/skk
        state: directory
        mode: '0755'
      become: yes

    - name: Download SKK-JISYO.L (large dictionary)
      get_url:
        url: https://raw.githubusercontent.com/skk-dev/dict/master/SKK-JISYO.L
        dest: /usr/share/skk/SKK-JISYO.L
        mode: '0644'
      become: yes

- name: Configure fcitx5 environment variables
  blockinfile:
    path: /etc/environment
    block: |
      # Fcitx5 input method
      GTK_IM_MODULE=fcitx
      QT_IM_MODULE=fcitx
      XMODIFIERS=@im=fcitx
      SDL_IM_MODULE=fcitx
      GLFW_IM_MODULE=ibus
    marker: "# {mark} ANSIBLE MANAGED BLOCK - fcitx5"
    create: yes
  become: yes

- name: Set fcitx5 as default input method
  shell: |
    im-config -n fcitx5
  become: no
  changed_when: false

- name: Create fcitx5 autostart directory
  file:
    path: "{{ ansible_env.HOME }}/.config/autostart"
    state: directory
    mode: '0755'
  become: no

- name: Create fcitx5 autostart entry
  copy:
    dest: "{{ ansible_env.HOME }}/.config/autostart/fcitx5.desktop"
    content: |
      [Desktop Entry]
      Name=Fcitx 5
      GenericName=Input Method
      Comment=Start Input Method
      Exec=fcitx5
      Icon=fcitx
      Terminal=false
      Type=Application
      Categories=System;Utility;
      StartupNotify=false
      X-GNOME-Autostart-Phase=Applications
      X-GNOME-AutoRestart=true
      X-GNOME-Autostart-Notify=false
      X-KDE-autostart-after=panel
    mode: '0644'
  become: no

- name: Inform user about fcitx5 configuration
  debug:
    msg: |
      Fcitx5 has been installed with CSKK support.
      After reboot, you can configure it with: fcitx5-configtool
      SKK dictionary is installed at: /usr/share/skk/SKK-JISYO.L
