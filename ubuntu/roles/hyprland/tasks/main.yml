---
# Hyprland desktop environment installation using cppiber PPA

- name: Download cppiber Hyprland PPA signing key
  shell: |
    curl -fsSL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xA54D23B62FF3FCC76EFF71E8FDBAAA1CF0CCF48E" | gpg --dearmor -o /usr/share/keyrings/cppiber-hyprland.gpg
  args:
    creates: /usr/share/keyrings/cppiber-hyprland.gpg
  become: yes

- name: Add cppiber Hyprland PPA repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/cppiber-hyprland.gpg] https://ppa.launchpadcontent.net/cppiber/hyprland/ubuntu {{ ansible_distribution_release }} main"
    state: present
    filename: cppiber-hyprland
  become: yes

- name: Update apt cache after adding PPA
  apt:
    update_cache: yes
  become: yes

- name: Remove conflicting Ubuntu hyprland packages
  apt:
    name:
      - hyprland-dev
      - libhyprutils0
      - libhyprlang2
      - libhyprcursor0
      - libudis86-0
    state: absent
    purge: yes
  become: yes
  ignore_errors: yes

- name: Install Hyprland and ecosystem from PPA
  apt:
    name:
      - hyprland
      - hyprpaper
      - hyprlock
      - hypridle
      - xdg-desktop-portal-hyprland
    state: present
  become: yes

- name: Install Wayland and graphics dependencies
  apt:
    name:
      # Wayland
      - wayland-protocols
      - libwayland-dev
      # Graphics
      - libdrm-dev
      - libgbm-dev
      - libegl1-mesa-dev
      - libgles2-mesa-dev
      - libgl1-mesa-dev
      # Input and display
      - libinput-dev
      - libxkbcommon-dev
      - libseat-dev
      - seatd
      # X11 support
      - xwayland
      - xauth
      - xserver-xorg
      - brightnessctl
    state: present
  become: yes

- name: Install Hyprland ecosystem packages
  apt:
    name:
      - foot  # Wayland terminal
      - wl-clipboard
      - dex  # XDG autostart
      - polkit-kde-agent-1  # PolicyKit authentication agent
      - xdg-desktop-portal
      - xdg-desktop-portal-gtk
    state: present
  become: yes

- name: Install Wayland tools and utilities
  apt:
    name:
      # Screenshot tools
      - grim
      - slurp
      - swappy
      # Notification
      - libnotify-bin
      # Background/wallpaper
      - swaybg
    state: present
  become: yes

- name: Install mako notification daemon
  apt:
    name: mako-notifier
    state: present
  become: yes
  ignore_errors: yes

- name: Install additional Hyprland tools
  block:
    - name: Install waybar dependencies
      apt:
        name:
          - libgtkmm-3.0-dev
          - libdbusmenu-gtk3-dev
          - libgirepository1.0-dev
          - libpulse-dev
          - libnl-3-dev
          - libnl-genl-3-dev
          - libspdlog-dev
          - libgtk-layer-shell-dev
          - libplayerctl-dev
          - libmpdclient-dev
        state: present
      become: yes
      ignore_errors: yes

    - name: Install waybar
      apt:
        name: waybar
        state: present
      become: yes
      ignore_errors: yes

    - name: Install rofi
      apt:
        name: rofi
        state: present
      become: yes
      ignore_errors: yes

    - name: Install cliphist via go install
      shell: |
        export GOPATH="$HOME/go" && export PATH="$PATH:$GOPATH/bin" && go install go.senan.xyz/cliphist@latest
      args:
        creates: "{{ ansible_env.HOME }}/go/bin/cliphist"
      become: no
      ignore_errors: yes

    - name: Install wlogout
      apt:
        name: wlogout
        state: present
      become: yes
      ignore_errors: yes

- name: Install display manager (ly) from source
  vars:
    ly_version: "v1.2.0"
  block:
    - name: Install ly build dependencies
      apt:
        name:
          - libpam0g-dev
          - libxcb-xkb-dev
          - xauth
          - xserver-xorg
        state: present
      become: yes

    - name: Remove old ly build directory
      file:
        path: /tmp/ly-build
        state: absent
      become: yes

    - name: Clone ly repository
      git:
        repo: https://github.com/fairyglade/ly.git
        dest: /tmp/ly-build
        version: "{{ ly_version }}"
        depth: 1
      become: no

    - name: Build and install ly with systemd support
      shell: |
        cd /tmp/ly-build
        zig build
        zig build installexe -Dinit_system=systemd --prefix / -Ddest_directory=/
      args:
        creates: /usr/lib/systemd/system/ly.service
      become: yes

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes
      become: yes

    - name: Disable existing display manager (gdm3)
      systemd:
        name: gdm3.service
        enabled: no
      become: yes
      ignore_errors: yes

    - name: Remove display-manager.service symlink if exists
      file:
        path: /etc/systemd/system/display-manager.service
        state: absent
      become: yes

    - name: Disable getty on tty2 (required for ly)
      systemd:
        name: getty@tty2.service
        enabled: no
      become: yes

    - name: Enable ly service
      systemd:
        name: ly.service
        enabled: yes
      become: yes

- name: Install nwg-shell tools
  block:
    - name: Install nwg-displays
      apt:
        name: nwg-displays
        state: present
      become: yes
      ignore_errors: yes

    - name: Install nwg-look
      apt:
        name: nwg-look
        state: present
      become: yes
      ignore_errors: yes

- name: Install GUI theming
  apt:
    name:
      - gnome-themes-extra
      - yaru-theme-icon
      - yaru-theme-gtk
      - papirus-icon-theme
    state: present
  become: yes

- name: Ensure systemd user directory exists
  file:
    path: "{{ ansible_env.HOME }}/.config/systemd/user"
    state: directory
    mode: '0755'
  become: no

- name: Create systemd user target for Hyprland session
  template:
    src: hyprland-session.target.j2
    dest: "{{ ansible_env.HOME }}/.config/systemd/user/hyprland-session.target"
    mode: '0644'
  become: no

- name: Enable systemd user targets
  systemd:
    name: "{{ item }}"
    enabled: yes
    scope: user
  loop:
    - hyprland-session.target
  become: no
  ignore_errors: yes

- name: Create XDG portal configuration directory
  file:
    path: "{{ ansible_env.HOME }}/.config/xdg-desktop-portal"
    state: directory
    mode: '0755'
  become: no

- name: Configure XDG Desktop Portal for Hyprland
  copy:
    dest: "{{ ansible_env.HOME }}/.config/xdg-desktop-portal/hyprland-portals.conf"
    content: |
      [preferred]
      default=hyprland;gtk
      org.freedesktop.impl.portal.Screenshot=hyprland
      org.freedesktop.impl.portal.ScreenCast=hyprland
      org.freedesktop.impl.portal.Inhibit=hyprland
      org.freedesktop.impl.portal.FileChooser=gtk
    mode: '0644'
  become: no

# InputActions - Mouse and touchpad gestures for Hyprland
- name: Build and install InputActions Hyprland plugin
  block:
    - name: Install InputActions build dependencies
      apt:
        name:
          - cmake
          - extra-cmake-modules
          - pkg-config
          - libevdev-dev
          - libyaml-cpp-dev
          - qt6-base-dev
          - libaquamarine-dev
          # hyprland headers are included in PPA's hyprland package
        state: present
      become: yes

    - name: Clone InputActions repository
      git:
        repo: https://github.com/taj-ny/InputActions.git
        dest: /tmp/inputactions-build
        depth: 1
      become: no

    - name: Build InputActions Hyprland plugin
      shell: |
        cd /tmp/inputactions-build
        rm -rf build
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DINPUTACTIONS_BUILD_HYPRLAND=ON
        make -j$(nproc)
      args:
        creates: /tmp/inputactions-build/build/src/hyprland/libinputactions-hyprland.so
      become: no

    - name: Install InputActions Hyprland plugin
      shell: |
        cd /tmp/inputactions-build/build
        make install
      args:
        creates: /usr/lib/hyprland/plugins/libinputactions-hyprland.so
      become: yes
      ignore_errors: yes
