---
# Base system configuration tasks

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Remove unwanted packages
  apt:
    name:
      - gnome-initial-setup
    state: absent
    purge: yes
  become: yes

- name: Upgrade all packages
  apt:
    upgrade: dist
  become: yes

- name: Enable universe and multiverse repositories
  apt_repository:
    repo: "{{ item }}"
    state: present
  loop:
    - "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} universe"
    - "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} multiverse"
  become: yes

- name: Install core system packages
  apt:
    name:
      # Build tools
      - build-essential
      - gcc
      - g++
      - make
      - cmake
      - pkg-config
      - autoconf
      - automake
      - libtool
      - bison
      - binutils
      # Libraries
      - zlib1g-dev
      - libreadline-dev
      - libyaml-dev
      - libffi-dev
      - libncurses5-dev
      - libgdbm-dev
      - libssl-dev
      - groff
      - libjemalloc-dev
      # Archive tools
      - unzip
      - p7zip-full
      # CLI tools
      - wget
      - curl
      - tree
      - ripgrep
      - jq
      - fzf
      - fd-find
      - bat
      - lsd
      - colordiff
      - peco
      - ldnsutils  # provides drill command
      - dnsutils   # provides dig command
      - libsecret-tools
      - libsecret-1-0
      - libsecret-1-dev
      # Terminal
      - tmux
      - kitty
      - alacritty
      # Networking
      - network-manager
      - network-manager-gnome
      - openssh-server
      # System utilities
      - software-properties-common
      - ca-certificates
      - gnupg
      - lsb-release
      - apt-transport-https
    state: present
  become: yes

- name: Create fd symlink for fd-find
  file:
    src: /usr/bin/fdfind
    dest: /usr/bin/fd
    state: link
  become: yes

- name: Install GitHub CLI
  block:
    - name: Download GitHub CLI GPG key
      get_url:
        url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
        dest: /usr/share/keyrings/githubcli-archive-keyring.gpg
        mode: '0644'
      become: yes

    - name: Add GitHub CLI repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
        state: present
      become: yes

    - name: Install gh
      apt:
        name: gh
        state: present
        update_cache: yes
      become: yes

- name: Set timezone
  timezone:
    name: "{{ timezone }}"
  become: yes

- name: Generate locale
  locale_gen:
    name: "{{ item }}"
    state: present
  loop:
    - "{{ locale }}"
    - "{{ locale_ctype }}"
  become: yes

- name: Set default locale
  lineinfile:
    path: /etc/default/locale
    regexp: '^LANG='
    line: 'LANG={{ locale }}'
  become: yes

- name: Set LC_CTYPE
  lineinfile:
    path: /etc/default/locale
    regexp: '^LC_CTYPE='
    line: 'LC_CTYPE={{ locale_ctype }}'
  become: yes

- name: Set hostname
  hostname:
    name: "{{ hostname }}"
  become: yes

- name: Update /etc/hosts with hostname
  lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: '127.0.1.1 {{ hostname }}'
  become: yes

- name: Ensure primary user exists
  user:
    name: "{{ primary_user }}"
    state: present
    groups: "{{ primary_user_groups }}"
    append: yes
    shell: /bin/bash
  become: yes

- name: Enable and start NetworkManager
  systemd:
    name: NetworkManager
    enabled: yes
    state: started
  become: yes

- name: Enable and start SSH
  systemd:
    name: ssh
    enabled: yes
    state: started
  become: yes

# Programming language runtimes (needed for building tools in other roles)
- name: Install Go
  apt:
    name: golang-go
    state: present
  become: yes

- name: Setup Go environment
  block:
    - name: Create Go directories
      file:
        path: "{{ ansible_env.HOME }}/go/bin"
        state: directory
        mode: '0755'
      become: no

    - name: Add Go bin to PATH
      lineinfile:
        path: "{{ ansible_env.HOME }}/.bashrc"
        line: 'export PATH="$HOME/go/bin:$PATH"'
        create: yes
      become: no

- name: Install Python
  apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - python3-dev
    state: present
  become: yes

- name: Install Node.js and npm
  apt:
    name:
      - nodejs
      - npm
    state: present
  become: yes

- name: Install Rust
  block:
    - name: Download and install rustup
      shell: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      args:
        creates: "{{ ansible_env.HOME }}/.cargo/bin/rustup"
      become: no

    - name: Add Rust to PATH in bashrc
      lineinfile:
        path: "{{ ansible_env.HOME }}/.bashrc"
        line: 'source $HOME/.cargo/env'
        create: yes
      become: no

    - name: Add cargo bin to PATH
      lineinfile:
        path: "{{ ansible_env.HOME }}/.bashrc"
        line: 'export PATH="$HOME/.cargo/bin:$PATH"'
        create: yes
      become: no

- name: Install Zig compiler (0.15.2)
  vars:
    zig_version: "0.15.2"
  block:
    - name: Check for Zig compiler
      shell: zig version 2>/dev/null || echo "not installed"
      register: zig_check
      changed_when: false

    - name: Download Zig
      get_url:
        url: "https://ziglang.org/download/{{ zig_version }}/zig-x86_64-linux-{{ zig_version }}.tar.xz"
        dest: /tmp/zig.tar.xz
      become: no
      when: zig_version not in zig_check.stdout

    - name: Remove old Zig installation
      file:
        path: /opt/zig
        state: absent
      become: yes
      when: zig_version not in zig_check.stdout

    - name: Extract Zig
      unarchive:
        src: /tmp/zig.tar.xz
        dest: /opt/
        remote_src: yes
      become: yes
      when: zig_version not in zig_check.stdout

    - name: Rename Zig directory
      command: mv /opt/zig-x86_64-linux-{{ zig_version }} /opt/zig
      become: yes
      when: zig_version not in zig_check.stdout
      args:
        creates: /opt/zig

    - name: Create Zig symlink
      file:
        src: /opt/zig/zig
        dest: /usr/local/bin/zig
        state: link
      become: yes

# GNOME Desktop Settings
- name: Set GTK key theme to Emacs
  command: gsettings set org.gnome.desktop.interface gtk-key-theme Emacs
  become: no
  changed_when: false
